#include <iostream>
#include <vector>
#include <chrono>
#include <random>
#include <algorithm>
#include <iomanip>
#include <cmath>

using namespace std;
using namespace std::chrono;

struct SortResult {
    long long comparisons;
    long long swaps;
    double time_ms;
};

void heapify(vector<int>& arr, int n, int i, long long& comparisons, long long& swaps) {
    while (true) {
        int largest = i;
        int left = 2 * i + 1;
        int right = 2 * i + 2;

        if (left < n) {
            comparisons++;
            if (arr[left] > arr[largest])
                largest = left;
        }

        if (right < n) {
            comparisons++;
            if (arr[right] > arr[largest])
                largest = right;
        }

        if (largest != i) {
            swap(arr[i], arr[largest]);
            swaps++;
            i = largest;
        }
        else {
            break;
        }
    }
}

SortResult heapSort(vector<int>& arr) {
    long long comparisons = 0;
    long long swaps = 0;
    int n = arr.size();

    auto start = high_resolution_clock::now();

    for (int i = n / 2 - 1; i >= 0; i--) {
        heapify(arr, n, i, comparisons, swaps);
    }

    for (int i = n - 1; i > 0; i--) {
        swap(arr[0], arr[i]);
        swaps++;
        heapify(arr, i, 0, comparisons, swaps);
    }

    auto end = high_resolution_clock::now();
    double time_ms = duration_cast<microseconds>(end - start).count() / 1000.0;

    return { comparisons, swaps, time_ms };
}

SortResult selectionSort(vector<int>& arr) {
    long long comparisons = 0;
    long long swaps = 0;
    int n = arr.size();

    auto start = high_resolution_clock::now();

    for (int i = 0; i < n - 1; i++) {
        int min_idx = i;

        for (int j = i + 1; j < n; j++) {
            comparisons++;
            if (arr[j] < arr[min_idx]) {
                min_idx = j;
            }
        }

        if (min_idx != i) {
            swap(arr[i], arr[min_idx]);
            swaps++;
        }
    }

    auto end = high_resolution_clock::now();
    double time_ms = duration_cast<microseconds>(end - start).count() / 1000.0;

    return { comparisons, swaps, time_ms };
}

vector<int> generateRandomArray(int size) {
    vector<int> arr(size);
    random_device rd;
    mt19937 gen(rd());
    uniform_int_distribution<int> dist(1, size * 10);

    for (int i = 0; i < size; i++) {
        arr[i] = dist(gen);
    }
    return arr;
}

vector<int> generateAlmostSortedArray(int size, double disorderPercentage = 0.05) {
    vector<int> arr(size);

    for (int i = 0; i < size; i++) {
        arr[i] = i + 1;
    }

    random_device rd;
    mt19937 gen(rd());
    int numDisorders = static_cast<int>(size * disorderPercentage);

    for (int i = 0; i < numDisorders; i++) {
        int idx1 = uniform_int_distribution<int>(0, size - 1)(gen);
        int idx2 = uniform_int_distribution<int>(0, size - 1)(gen);
        swap(arr[idx1], arr[idx2]);
    }

    return arr;
}

bool isSorted(const vector<int>& arr) {
    for (size_t i = 1; i < arr.size(); i++) {
        if (arr[i] < arr[i - 1])
            return false;
    }
    return true;
}

void printTableHeader() {
    cout << "\n" << string(120, '=') << endl;
    cout << setw(10) << "Размер";
    cout << setw(20) << "Selection (мс)";
    cout << setw(20) << "Heap (мс)";
    cout << setw(20) << "Sel свопы";
    cout << setw(20) << "Heap свопы";
    cout << setw(15) << "Sel сравн";
    cout << setw(15) << "Heap сравн" << endl;
    cout << string(120, '=') << endl;
}

void runRandomTest() {
    vector<int> sizes = { 10, 20, 50, 100, 200, 500, 1000, 2000, 5000, 10000 };
    const int TESTS_PER_SIZE = 100;

    cout << "\nТЕСТИРОВАНИЕ НА СЛУЧАЙНЫХ МАССИВАХ" << endl;
    cout << "Размеры: ";
    for (int size : sizes) cout << size << " ";
    cout << "\nТестов на размер: " << TESTS_PER_SIZE << endl;

    printTableHeader();

    for (int size : sizes) {
        long long total_sel_time = 0;
        long long total_heap_time = 0;
        long long total_sel_swaps = 0;
        long long total_heap_swaps = 0;
        long long total_sel_comps = 0;
        long long total_heap_comps = 0;

        for (int test = 0; test < TESTS_PER_SIZE; test++) {
            vector<int> original = generateRandomArray(size);

            vector<int> data1 = original;
            SortResult sel_res = selectionSort(data1);
            total_sel_time += sel_res.time_ms;
            total_sel_swaps += sel_res.swaps;
            total_sel_comps += sel_res.comparisons;

            vector<int> data2 = original;
            SortResult heap_res = heapSort(data2);
            total_heap_time += heap_res.time_ms;
            total_heap_swaps += heap_res.swaps;
            total_heap_comps += heap_res.comparisons;

            if (!isSorted(data1) || !isSorted(data2)) {
                cout << "ОШИБКА сортировки!" << endl;
            }
        }

        double avg_sel_time = total_sel_time / (double)TESTS_PER_SIZE;
        double avg_heap_time = total_heap_time / (double)TESTS_PER_SIZE;
        long long avg_sel_swaps = total_sel_swaps / TESTS_PER_SIZE;
        long long avg_heap_swaps = total_heap_swaps / TESTS_PER_SIZE;
        long long avg_sel_comps = total_sel_comps / TESTS_PER_SIZE;
        long long avg_heap_comps = total_heap_comps / TESTS_PER_SIZE;

        cout << fixed << setprecision(4);
        cout << setw(10) << size;
        cout << setw(20) << avg_sel_time;
        cout << setw(20) << avg_heap_time;
        cout << setw(20) << avg_sel_swaps;
        cout << setw(20) << avg_heap_swaps;
        cout << setw(15) << avg_sel_comps;
        cout << setw(15) << avg_heap_comps << endl;
    }
}

void runAlmostSortedTest() {
    vector<int> sizes = { 10, 20, 50, 100, 200, 500, 1000, 2000, 5000, 10000 };
    const int TESTS_PER_SIZE = 100;
    const double DISORDER = 0.05;

    cout << "\nТЕСТИРОВАНИЕ НА ПОЧТИ ОТСОРТИРОВАННЫХ МАССИВАХ" << endl;
    cout << "Размеры: ";
    for (int size : sizes) cout << size << " ";
    cout << "\nТестов на размер: " << TESTS_PER_SIZE << endl;
    cout << "Беспорядок: " << (DISORDER * 100) << "%" << endl;

    printTableHeader();

    for (int size : sizes) {
        long long total_sel_time = 0;
        long long total_heap_time = 0;
        long long total_sel_swaps = 0;
        long long total_heap_swaps = 0;
        long long total_sel_comps = 0;
        long long total_heap_comps = 0;

        for (int test = 0; test < TESTS_PER_SIZE; test++) {
            vector<int> original = generateAlmostSortedArray(size, DISORDER);

            vector<int> data1 = original;
            SortResult sel_res = selectionSort(data1);
            total_sel_time += sel_res.time_ms;
            total_sel_swaps += sel_res.swaps;
            total_sel_comps += sel_res.comparisons;

            vector<int> data2 = original;
            SortResult heap_res = heapSort(data2);
            total_heap_time += heap_res.time_ms;
            total_heap_swaps += heap_res.swaps;
            total_heap_comps += heap_res.comparisons;

            if (!isSorted(data1) || !isSorted(data2)) {
                cout << "ОШИБКА сортировки!" << endl;
            }
        }

        double avg_sel_time = total_sel_time / (double)TESTS_PER_SIZE;
        double avg_heap_time = total_heap_time / (double)TESTS_PER_SIZE;
        long long avg_sel_swaps = total_sel_swaps / TESTS_PER_SIZE;
        long long avg_heap_swaps = total_heap_swaps / TESTS_PER_SIZE;
        long long avg_sel_comps = total_sel_comps / TESTS_PER_SIZE;
        long long avg_heap_comps = total_heap_comps / TESTS_PER_SIZE;

        cout << fixed << setprecision(4);
        cout << setw(10) << size;
        cout << setw(20) << avg_sel_time;
        cout << setw(20) << avg_heap_time;
        cout << setw(20) << avg_sel_swaps;
        cout << setw(20) << avg_heap_swaps;
        cout << setw(15) << avg_sel_comps;
        cout << setw(15) << avg_heap_comps << endl;
    }
}

int main() {
    setlocale(LC_ALL, "Russian");

    cout << "ПРОГРАММА ТЕСТИРОВАНИЯ СОРТИРОВОК" << endl;
    cout << "=================================" << endl;

    while (true) {
        cout << "\nВыберите тест:" << endl;
        cout << "1 - Случайные массивы" << endl;
        cout << "2 - Почти отсортированные массивы" << endl;
        cout << "3 - Выход" << endl;
        cout << "> ";

        int choice;
        cin >> choice;

        if (choice == 1) {
            runRandomTest();
        }
        else if (choice == 2) {
            runAlmostSortedTest();
        }
        else if (choice == 3) {
            cout << "Выход..." << endl;
            break;
        }
        else {
            cout << "Неверный выбор!" << endl;
        }
    }

    return 0;
}
